#include <xs1.h>

.text
.globl _start
.globl _start.nstackwords
#if defined(__XS2A__)
  .align 4
  .issue_mode single
  _start:
    ENTSP_lu6 0
#else
  .align 2
  _start:
#endif
.set _start.nstackwords, XS1_DBG_BUFFER_WORDS + 1 + (memset.nstackwords)

.set _DoSyscall, 0x404e8

.set _DoException, 0x40234

//Relocate to the end of memory
.set decompressor_bytes, _edp.bss - _start
.set decompressor_words, (decompressor_bytes + 3) / 4
.set decompressor_src, _start
.set decompressor_dest, .ram_base + .ram_size - (_start.nstackwords * 4 + decompressor_words * 4 + (0x40000 - .ram_base))
.set decompressor_offset, decompressor_dest - decompressor_src
.set done_offset, done + decompressor_offset

  ldap r11, decompressor_src
  mov r0, r11
  ldap r11, decompressor_dest
  ldc r1, decompressor_words
relocation_loop:
  sub r1, r1, 1
  ldw r2, r0[r1]
  stw r2, r11[r1]
  bt r1, relocation_loop
.set relocation_jump_dest, decompressor + decompressor_offset
  bl relocation_jump_dest

//The compressed binary
compressedBinary:
    .byte     0, 240,  64, 119,  75, 104, 209, 254
    .byte   236,  23,   4, 240, 139, 104, 194, 254
    .byte   236,  31, 195, 134, 121, 216,   2, 115
    .byte    93, 255, 236,   7, 212,   6,  68, 116
    .byte   240,  31, 116, 208,   0, 240, 138, 111
    .byte   240,  23, 224,  23,   0, 240,  20,  96
    .byte    64, 104,   0, 240, 139, 108,   0, 240
    .byte     1, 209,   0, 240,   7, 108,  42,  23
    .byte   140,  42,   7, 250,  59,   3, 252, 208
    .byte     1, 240,   2, 210,   0, 240, 198, 106
    .byte   200, 234, 207, 234,   0, 104,   1,  84
    .byte     0, 240,  64, 104,  72, 120,   1, 100
    .byte     0, 240, 196, 208, 176, 248, 236, 151
    .byte   194, 122,   1, 144, 240,  79,  65,  42
    .byte     8, 142, 208,   2, 112,   0, 240, 193
    .byte    59,  12, 203, 208, 255,  23,  42, 241
    .byte    42, 241,  42, 241,  42, 241,  42, 241
    .byte    42, 241,  42, 209,   0, 240,  64, 119
    .byte     0, 240, 150, 208,   1, 208, 238,   7
    .byte     7, 220, 255,   7,   1, 240, 206, 217
    .byte   251,  55,   0, 240,  70, 111, 192, 106
    .byte   251,  47, 192, 119, 192, 119,   0,   0
    .byte   255,  23, 134, 127,   5, 249, 236, 247
    .byte    72, 144, 132,  85,  84, 144,  96, 144
    .byte     0, 240,  93, 208,   0, 240,   4, 120
    .byte    18, 176,  59,  81,  71, 120,   3, 240
    .byte    19, 104,   0, 240,   8, 115, 200, 144
    .byte   212, 144, 224, 144,  42,  26,  88, 208
    .byte    64,  42,  36,   7, 115,   1,  59, 131
    .byte     4,  59,   3,  18, 104, 208, 144, 228
    .byte    59,  15, 143,  59,  15,   1, 115,  16
    .byte   167, 255,  23, 192, 144, 132,  93,  59
    .byte    29, 239, 255,  23, 198,  59,  51,  66
    .byte   119,   0, 115,  42,  17, 194, 119,  66
    .byte   119, 194, 134,   2, 116, 120, 240,   2
    .byte    59,  28, 207, 110,  92,  23, 209,  78
    .byte    92, 191, 194, 122, 209, 206,  42,   4
    .byte   143, 209, 206,   5,  42,  11,  48, 209
    .byte     0, 240,  64, 127,   0, 104,  96, 104
    .byte     2, 105, 172,   9, 184, 172,  56,  71
    .byte    88,  48,  71, 121, 168, 164, 104,  66
    .byte   188, 164, 124,  66, 222,  22, 124, 148
    .byte     3, 115, 160,  42,   7, 226,  23,   1
    .byte   144,  33,  48, 146, 124,   0, 240,  49
    .byte   212,   0, 104, 194, 119,   0,   0,  62
    .byte     8, 105,  36, 144,  16, 144,  13,  59
    .byte    20, 117, 217, 251,  39,  59, 173, 104
    .byte    16,  59,  61, 118,  59,  27, 122, 209
    .byte     1, 240,  46,  42,   4, 124,  42,   2
    .byte    68, 119,   2,  85,  64, 144,  62,   8
    .byte   226, 105,  42,   7, 109,  42,  13,  33
    .byte   209, 192,  62,  32,   5,  64, 119, 237
    .byte     7, 236,   7,   0, 240, 193, 110, 255
    .byte    23,  59,  83,  64, 119, 201, 134,  42
    .byte     3,  96, 238,  23, 167, 252, 236,   7
    .byte    62,   8, 139,  62,  24, 157, 128,  42
    .byte     9, 171,  76, 226,  23, 192, 119, 255
    .byte    23, 128, 127, 129, 135,  62,   8, 119
    .byte    23,  80, 255,  42,  72,  42,  84,   0
    .byte   240,  87,  88,  59,  53, 112, 133,  59
    .byte   129,  87,  80, 197, 182,  62,   8, 190
    .byte    42,  94,  23,  88, 192, 174,  42, 152
    .byte     8,  88,  42,  22,  59,  97,  56, 144
    .byte    62,   8,  86,   6, 104,   4, 240,  52
    .byte   115,  62,  56,  25,  62,  24, 199, 255
    .byte    23, 132,  85,   0, 240, 181,  62,  32
    .byte   181, 184, 208,  96,  42,  36, 191, 208
    .byte     0, 240,  35, 212,   0, 240, 223,  42
    .byte     4,  18, 120,   3, 240,   9, 104,   0
    .byte   240, 200, 208, 113,  71, 255,  23, 196
    .byte     7,  42,   2,  59, 131, 199, 208, 130
    .byte    42,   6,   0, 240, 197,  59,   3, 210
    .byte    42,   2,  23,  59,   9,  10,  88,  42
    .byte     2, 120, 103, 104,  42,  28, 145, 108
    .byte   192,  59, 133, 133, 208,  17, 167,  42
    .byte    20,   5, 115,   0, 240, 207,  59,   5
    .byte   175,  42,   2,  54,  59,   7,  20, 115
    .byte     0, 105, 255,  23,   3, 240,  11,  59
    .byte    31, 177, 208,  59, 219, 178, 208,   0
    .byte    59, 143, 176,  59,   3,  16, 108,   0
    .byte   240, 174,  42,   4, 187,  42,   2,  62
    .byte     9, 114,  59,  95,   4, 120,   0, 240
    .byte     3, 121, 156,  59,  11, 212, 254, 236
    .byte    59,   5,  66, 116,  15, 240,  40,  62
    .byte     9, 159,  59,   1, 153, 208, 255,  23
    .byte    62,  57,   5,  62,  40,  97,  46,  62
    .byte    17,  57,  62,   9,  56,  59,  93,  82
    .byte    59,  45, 125, 208, 112, 144, 200, 144
    .byte     0, 240, 148, 208, 144,  59, 189, 146
    .byte   208, 131,  62,  16,  85, 147, 208, 129
    .byte    42,  36, 145,  59,  23,  69, 121, 128
    .byte    59,  63, 255,  23,   2, 139,   0, 240
    .byte   138, 208,  21, 153,   1, 145,   0, 240
    .byte    68, 117,   0, 240, 152,  42,  14,  92
    .byte   212,  59,  27, 239,  62,  57,  57,  64
    .byte   119, 225, 143, 238,  59,  13, 128,  96
    .byte   171,  76,  48, 248, 236, 151, 198, 120
    .byte     0, 240, 210, 108,  55,  16, 222,  22
    .byte   137, 232, 206, 182,   4,  16, 210,  42
    .byte     4, 194, 182,  62,  40, 231, 129, 135
    .byte     0, 240,  24,  80,  62,  24, 189,   0
    .byte   240,  88,  88, 197, 182,  16,   8,  37
    .byte   144,  32,  42,  14, 152,  88, 202, 174
    .byte    33,   8,  41,  48, 131, 124,  62,  40
    .byte     7,  17,   8,  21, 144,  17,   0,  59
    .byte   199, 212, 166,  16,   0,  64, 104,  42
    .byte    39,  42,  46, 238,  23,  16,   8, 151
    .byte    52,  83, 112,  59, 211,  32,   8, 212
    .byte   166,   7, 115,  59, 211,  42,  35,  42
    .byte     9,  41,  48, 137, 124, 176,  59,   7
    .byte    59,   1, 174,  62,  48,  22,  62,  40
    .byte    29, 152,  17,   0,  72,  62,  32,  15
    .byte    59,  94,  59,  59,  88, 192, 174,  62
    .byte    40,   1, 208, 166,  59, 235,  42,  56
    .byte    66,  42,   6,   8, 212,  62,  25, 123
    .byte    42,  22,  36, 209,  62,  41, 129,   7
    .byte   104,   0, 240,  25, 212,  62,  17,  98
    .byte    42,  40,  16, 144,   0,  42,   9,  34
    .byte    42,  57,  59, 135,  40, 212, 196, 142
    .byte    87, 170,  65, 120, 194, 119, 196, 150
    .byte    65,  84,   0, 240,  14, 209,  65,  92
    .byte    16,   0, 208, 166,  59,  18,  59,   9
    .byte     8, 243, 204, 104, 193, 106,  62,   9
    .byte   228,  62,  33, 117,  85, 193, 172,  30
    .byte   113, 197, 172,  28, 113, 129, 164,   3
    .byte    64,   2, 135, 144,  23,   3, 240, 192
    .byte   104,   3,  79, 195, 122,  64, 173, 128
    .byte   164,   4, 115, 128, 172,  60, 167,   3
    .byte    64, 128, 164, 180, 172,  42,   3, 175
    .byte   148,  15, 136, 175,  17,  79, 201, 122
    .byte   144, 135,   3, 176,  17, 207, 228,  23
    .byte     0,  93, 192, 119,  59,  49,  42,   3
    .byte   228,  23,   1,  42,  36,  59, 155, 242
    .byte     3, 104,  62,   8,  85, 224, 143,  62
    .byte    25, 109,  42,  84, 197, 134, 128, 127
    .byte   226, 143, 255,  23,   8,  16, 255,  23
    .byte   209,  22, 255,  23,  73, 232, 255,  23
    .byte   193, 182, 255,  23, 225,  62,  49, 145
    .byte    12,  88,  72, 104,  42,  14, 254, 236
    .byte    47, 148, 167,  42,  52,   0,  59,  22
    .byte    42,  62,  76,  88, 211, 166, 255,  23
    .byte   212,  42,  42,  42,  52,  62,  25, 155
    .byte   130,  42,  14,  82, 208, 255,  23, 194
    .byte    42,   6, 132, 127,  64, 144,   2,  85
    .byte    48,  71,  62,   9,  27,  77, 208,  64
    .byte   173, 255,  23,  42,  54,  74, 208,  65
    .byte    42, 102,  71, 208,  66,  42,   6,   0
    .byte   240,  69,  59,  11,   2,  93, 255,  23
    .byte   196,  62,  32,  19,  86,  62,  32,  19
    .byte    42,  22,  71, 208,   0, 240,  87, 208
    .byte   209, 166,  42,  88,  73,  42,  46,  62
    .byte    24, 161,  16,  96,   0, 240,   8, 213
    .byte    62,  24, 185,  62,  10,  53,   0, 240
    .byte    18,  42,   9,  17, 213,   0, 240,  25
    .byte    88,  30, 112, 128, 104,   0, 240, 148
    .byte    80, 210, 166,   0, 240,  21,  80,   0
    .byte   240,  26,  42,  13,  22,  42,   4,  13
    .byte    88,  68,  42,  12,  29,  59,  28,  14
    .byte    88,  73, 104,  17, 167, 224, 144,  42
    .byte    12,  42,   7,  15,  88,  82, 104, 130
    .byte    42,  13,  16,  42,   6,  25,  81,  59
    .byte   214,  24, 213,   2,  93, 196,  62,  64
    .byte    39,  32,  62,  32,  39,  66, 119, 192
    .byte   104,  48,   0,  49,   0,  50,   0, 179
    .byte   248, 236, 159, 159, 249, 236, 135,  78
    .byte   104,  17,  16,  39, 248, 236, 135, 112
    .byte     2, 113,   2, 114,   2,  67,   2,   0
    .byte   240, 228, 217,  48,   5,   0, 240,   3
    .byte   218,  49,  42,   3,  46, 218,  50,  42
    .byte     3,  81, 218,  51,   5,   1, 240,  84
    .byte   104,   1,  16,   0, 240, 107,  59,  86
    .byte    59, 157, 196, 217, 140, 145,  62,   9
    .byte   176,  62,  24, 251, 238,  23,   1, 240
    .byte    31,  96, 131, 252, 236,  31,  62,  41
    .byte   131,  74,  88,  75, 120,   0, 240, 137
    .byte    88, 135, 112,   0, 240,  75,  88,  69
    .byte   120, 202, 134, 214,  22,  42,   8,  80
    .byte   210,  14,  62,  58, 145,  75,  88,   0
    .byte   240,  72, 124,  42,  93,  42, 124,  73
    .byte    42,  12,  84, 124, 225,  23,  62,   8
    .byte   118,  42, 156,  74,  88,  68,  59, 155
    .byte   129, 120, 217,  78,  62,  56,  37,  72
    .byte    42,  42, 133,  42,  10,   1, 240, 213
    .byte   106,  43,  79,  42,  94, 132, 119,   4
    .byte   249, 236, 247, 130,  85,  46, 120,  64
    .byte   154,   1, 240, 103,  88, 192, 104,  80
    .byte   120, 176,   8, 204,  17,   1, 240, 167
    .byte    96,  84,   8,  37,  17,  40,  49, 139
    .byte   113, 164,  50, 151, 113,  81, 200,  90
    .byte   113, 100, 146,  24,   8,  75, 116,  23
    .byte   115,  42,  30,  20, 115, 237,  19,  36
    .byte     0,  53,   8, 210,  59,   8, 140,  17
    .byte     3,  48,  14, 120,  12,   8,   2,  16
    .byte     4,   0,  13,   8,   5,   0,   8, 115
    .byte   253,  19,  48,   0,  21,   8,  17,   0
    .byte     2, 115,  52, 144,  49,   0,   8,   0
    .byte   130,  93,  59,  36, 239, 132, 103,  59
    .byte   107,  62,  27,  27,   0, 240, 194,  62
    .byte    19,  22,  67, 212,   0, 240, 197, 209
    .byte    62,  16, 182,   0,   0, 240,  76, 119
    .byte     6,  59,  56,  47,  42,   2,  68, 252
    .byte   236, 247, 138,  86,   3,  84,  62,   8
    .byte   243, 192, 105,   0, 240,  84,  96,   1
    .byte   240, 156, 106,   8, 240,  64, 106,  28
    .byte   145,  69,   8, 209, 166, 192, 192,  41
    .byte   112,  66,  84, 102,   8,   1, 153,  75
    .byte   249, 236, 159, 195, 131,  49,  71,  29
    .byte   120, 145,  60,  72, 112,   1, 240,  20
    .byte   104, 200,  16,   0, 240,  37, 214,  42
    .byte    26,  14, 120,  78, 104, 217,  16,  87
    .byte   130,  53,  71,  57, 167,  22,  48,  69
    .byte   112, 200, 144,  67,  92, 225,  39, 145
    .byte    66, 195, 131, 129,  60,   5,  62,  48
    .byte     7,  29, 214, 170,  21,  12, 195,  38
    .byte   116,   1, 115,  66,  84,  66,  92,  20
    .byte     8, 113, 116,   0, 240,  13, 213, 196
    .byte   144, 138,  94,  59,  52, 239,  59,  56
    .byte   239,  59,  60, 239, 204,  62,   8, 149
    .byte   119,  62,  42, 173,   7, 250, 236, 247
    .byte   136,  86,  62,   8,  85,  25,  88,  62
    .byte    12,  85,  83, 213,  83,  59,  53, 192
    .byte   105, 199, 131,   8, 240,   0, 106, 144
    .byte    60,  66, 120,  49,  71,   7, 115,  59
    .byte    98, 192,  59,  34, 108, 214,   0, 104
    .byte   132, 129,  16, 144,  53,  55, 136, 104
    .byte    38,  56, 156, 120,  80,  11, 118, 121
    .byte   224,   8, 169,  26,  16,   1, 214,  70
    .byte    65, 112, 113,  11,  50,   1, 213, 166
    .byte   217, 192,  78, 112, 192, 105, 241,  13
    .byte    19,  11, 204, 144, 228, 144, 248, 144
    .byte   235,  39, 220, 192, 105, 120,  20,  17
    .byte    40,  25,  14, 195,  12, 116, 199, 131
    .byte   128,  60,  29, 115,  32, 240,   0, 104
    .byte    20,  64, 128, 106,  22, 254, 236, 135
    .byte   193,   8, 136, 193,   7, 112,  60,  59
    .byte    97,   8, 217, 166,   2, 192,   1, 240
    .byte    27, 112, 146,  13,   1, 240,  88, 121
    .byte    64, 240, 192, 105,  71,  58,  20, 120
    .byte     1, 240,  16,  42,  15,  96,   8,  29
    .byte   115, 132,  60,  64, 105,   1, 240,  52
    .byte   112,   1, 240,  45, 115, 199, 131,   1
    .byte   240,  64, 104,  17,  64, 215, 251, 236
    .byte   135, 128,  60,   1, 240,  15, 115,  19
    .byte    11, 192, 105, 221, 166, 204, 144, 236
    .byte   144, 229,  39,  96, 144,  20, 167,   9
    .byte    51,   1, 240,   7, 112, 215, 131,  59
    .byte    85,   4, 104,   4,  56,  10, 120, 193
    .byte     8,  40,  25,  48,  59, 166,   4, 120
    .byte    59, 234,  40,  25, 242,  13,  19,  11
    .byte    64, 105, 196, 144, 232, 144, 244, 144
    .byte   235,  39, 229, 131,  66,  50,  36, 120
    .byte   223, 243,  63, 104,  24,  56, 213,  59
    .byte    30,  17,   1,   0,  11, 192,   0,  75
    .byte    58,   4,  62,  40,  52,   0,  48, 104
    .byte    32,  17, 200,   8,   9,  42,   8, 128
    .byte   104, 226,  16,  34,  48, 131, 112,  62
    .byte     8, 223, 213, 131,  24,   1, 132,  62
    .byte    32, 183,  62,   8, 134, 227, 214, 216
    .byte   145,  32, 115,   1, 240,   0, 104,   8
    .byte    64, 197,  59,  21, 136,  60,  20, 167
    .byte    24, 112,  18, 115,   0, 240, 162, 213
    .byte     0,   8,  93, 104,  17,  48, 199, 131
    .byte    66, 120,  28, 145,  62,   8, 159,  64
    .byte   104,   1,  64,  49,  71,  64, 104, 133
    .byte   249,  62,   8,  86,  62,  56,  19,   5
    .byte   215, 196, 144, 136,  94,   7, 250, 236
    .byte   239,  62,  43,  88, 202,  62,  17, 185
    .byte     3, 120,  59,  33, 212,   4, 115,   7
    .byte   220,  62,   9, 188,  56,  62,  50,  31
    .byte    62,   8, 219,  68, 144,  14,  59,  15
    .byte    64, 105,  65, 130,  24, 144,  44, 144
    .byte     0, 240, 131, 208,  16, 248, 236, 151
    .byte    71,  59,  27,  80, 104, 209,  16,  36
    .byte     8,  40,  16,  36,   0,   8, 115, 211
    .byte   248, 236, 159, 101, 130, 191, 243, 255
    .byte   104,  43,  56, 101, 250, 236, 135,  59
    .byte    95,  62,  10,  19,  72,  62,  48, 253
    .byte     6,  86,  76, 144,  88, 144, 100, 144
    .byte    62,   9,  60, 192, 105, 195, 131,   4
    .byte    62,   8, 167,  56,  73, 120,  14, 104
    .byte   200,  16,  67, 130, 130, 104, 220,  59
    .byte    31,  95, 208, 195, 131,   1, 115,  49
    .byte    71, 191, 243, 127, 104,   1,  56, 195
    .byte   251, 236, 135,  42,  63,  62,  13,  14
    .byte     1, 240,  54, 213,   6,  94,  62,  40
    .byte    77, 200,  62,  17, 137,  62, 136,  65
    .byte    61, 208,  59, 247, 220, 166,  51,  48
    .byte   202, 112,  64, 240, 192, 104,  43,  64
    .byte    59, 122,  62,  24,  73,   4,   0,   5
    .byte   115,  62, 112,  68,  62,  18,  95,  14
    .byte   104,   4,  16,  64, 104,   1, 128,   0
    .byte   240,  38,  62,  10,  60,  42,  42,   1
    .byte   240,  40,  96,   0, 240, 220, 215,  42
    .byte   184, 212,  42,  72,  62,  44, 163,  62
    .byte    13,  43, 126, 223, 251,  39,  42, 154
    .byte     8,  42,  10, 136,  42, 106,  16, 144
    .byte     4,  42,   8, 144,  42,  72,  59,  85
    .byte    12, 212,   0, 240,  14, 109,   6, 121
    .byte     0, 240,  72, 109,   1, 153,   4,  75
    .byte   224,  39,   4, 117,  62,  26, 127, 132
    .byte   119,   1,  85,  66,  85, 131,  85,   0
    .byte   240, 141, 109, 136, 121,   0, 105,   0
    .byte   240,  73, 109,  59,  65,   1, 145, 178
    .byte   203, 197, 118,   1, 240,  31, 213,   1
    .byte    93,  66,  93, 131,  93, 132, 103, 194
    .byte   119,  12,   0,  59,  25,  42,   1,   1
    .byte     0,   1,   1,  15,  12,  14,   0, 255
    .byte    42,   6, 112,  23, 240, 255,  48,  24
    .byte   240, 255,  56,  27, 240, 255,  28,  28
    .byte   240, 255,  42,  31,   0,  13,   4,   0
    .byte   168,  14,   4,   0, 252,  12,   4,  42
    .byte    38, 120, 255,   7,   0,  88,   1,  59
    .byte   207,  59, 209,   0,   0,   2,  31,   2
    .byte   128,  42,   6,   1,  68,  51,  34,  17
    .byte   255, 255, 255, 127, 208,   2,   4,  42
    .byte    44,  42, 241,  42, 241,  42,  17,   2
    .byte     1,   0, 128,   6,  42,   4, 104,  59
    .byte    33, 196,  42,   2,  32,  59,  41,  59
    .byte    21,  59,  49,   0,  42, 100
    .align 2
compressedBinaryEnd:

//Code for decompressing the compressed binary
decompressor:
    ldc r0, 42
    ldc r1, 59
    ldc r2, 62
    ldap r11, compressedBinaryEnd
    or r3, r11, r11
    ldc r4, 0x400
    shl r4, r4, 8
    or r5, r4, r4
    ldap r11, compressedBinary
    ldc  r6, 0
loop:
    lsu  r10, r11, r3
    bf   r10, done
    ld8u r7, r11[r6]
    add  r11, r11, 1
    eq   r10, r7, r0
    bt   r10, marker
    eq   r10, r7, r1
    bt   r10, marker
    eq   r10, r7, r2
    bt   r10, marker
copyChar:
    st8  r7, r4[r6]
    add  r4, r4, 1
    bu   loop
marker:
    ld8u r8, r11[r6]
    add  r11, r11, 1
    bf   r8, copyChar
    eq   r10, r7, r0
    bt   r10, marker0
    eq   r10, r7, r1
    bt   r10, marker1
marker2:
    shr  r7, r8, 3
    zext r8, 3
    ld8u r10, r11[r6]
    add  r11, r11, 1
    shl  r8, r8, 8
    or   r8, r8, r10
    bu   adjustR8
marker1:
    shr  r7, r8, 6
    zext r8, 6
adjustR8:
    add  r8, r8, 11
    add  r8, r8, 4
    bu   copyManyChars
marker0:
    shr  r7, r8, 4
    zext r8, 4
copyManyChars:
    shl  r8, r8, 1
    add  r7, r7, 3
    sub  r9, r6, r8
loopChar:
    ld8u r10, r4[r9]
    st8  r10, r4[r6]
    add  r4, r4, 1
    sub  r7, r7, 1
    bt   r7, loopChar
    bu   loop
done:
    bau  r5

